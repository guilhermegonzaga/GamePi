<!DOCTYPE html>
<html lang="pt-br">

	<head>

		<meta charset="utf-8"/>

		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.min.css">

		<link rel="stylesheet" type="text/css" href="css/game.css">

		<script src="https://code.createjs.com/createjs-2014.12.12.min.js"></script>

		<script src="js/funcs.js"></script>

		<title>Game PI</title>

	</head>

	<body onload="load();">

		<script>

			var palco, loader, cwidth,

			nome = "Hacker vs. Vírus",
			cheight = 580,
			marginX = 20,
			chao = 55,
			pos = 0,
			canvasInicio = 0,
			canvasFim = 0,

			KEYS = {
				LEFT: 37,
				RIGHT: 39,
				UP: 38,
				DOWN: 40,
				SPACE: 32,
				_keys: []
			},

			ESTADOS = {
				SPLASH: 1,
				JOGANDO: 2,
				PERDEU: 3,
				SCORE: 4
			};

			function load(){

				/* Salva o tamanho da tela */
				cwidth = window.innerWidth;

				/* Trava em no máximo 1920px */
				if(cwidth > 1920)
					cwidth = 1920;

				/* Salva o tamanho da canvas */
				canvasFim = cwidth;

				/* Cria a canvas com as determinadas dimensões */
				canvas = document.createElement('canvas');
				canvas.width = cwidth;
				canvas.height = cheight;

				/* Adiciona a canvas na tela */
				document.body.appendChild(canvas);

				/* Inicia o createjs */
				palco = new createjs.Stage(canvas);

				/* Habilita o uso de touch screen */
				//createjs.Touch.enable(palco);

				/* Manifest: Imagens e sons a serem carregados */
				manifest = [
					{src: "cenario.png", id: "cenario"},
					{src: "virus.gif", id: "virus"},
					{src: "personagem.png", id: "personagem"},
					{src: "bala.png", id: "tiro"},
					{src: "coin.png", id: "moeda"},
					{src: "municao.png", id: "municao"},
					{src: "bg.jpg", id: "bg"},
					{src: "jogar.png", id: "jogar"},
					{src: "creditos.png", id: "creditos"},
					{src: "back.png", id: "back"}
				];

				/* Carrega o manifest e iniciar() o jogo */
				loader = new createjs.LoadQueue(false);
				loader.addEventListener("complete", iniciar);
				loader.loadManifest(manifest, true, "img/")

			}

			function iniciar(){

				/* Cria o background do menu */
				bgImg = loader.getResult("bg");
				bg = new createjs.Shape();

				/* Animações do personagem */
				spritePersonagem = new createjs.SpriteSheet({
					framerate: 15,
					images: [loader.getResult("personagem")],
					frames: [
						[3,0,76,83],
						[88,0,79,83],
						[175,0,67,83],
						[265,0,80,83],

						[0,94,61,83],
						[67,94,70,84],
						[147,94,71,86],
						[232,94,60,91],
						[304,94,64,90],
						[378,94,64,92],

						[0,187,61,83],
						[77,192,60,78],
						[154,208,60,63],
						[231,210,60,61],

						[0,292,60,95],
						[76,292,61,95],
						[153,293,63,85],
						[225,293,68,78],
						[309,293,67,78],

						[0,403,60,84],
						[70,405,71,81],
						[149,413,82,72],
						[242,413,82,72],
						[335,413,82,72],

						[0,506,84,61],
						[102,506,85,61],
						[202,506,84,61],
						[304,511,92,39]
					],
					animations: {
						"parado": 10,
						"agachado": 13,
						"andar": [4, 9, "parado", 0.3],
						"pular": [14, 18, "pular", 0.3],
						"saltar": [14, 18, "saltar", 0.3],
						"morreu": [19, 27, 0.3],
						"agachar": [10, 13, "agachado", 0.7],
						"atirar": {
							frames: [1,0,3,2],
							next: "parado",
							speed: 1.3
						},
						"subir": {
							frames: [13,12,11,10],
							next: "parado",
							speed: 0.7
						}
					}
				});

				/* Animações do vírus */
				spriteVirus = new createjs.SpriteSheet({
					framerate: 20,
					images: [loader.getResult("virus")],
					frames: [
						[10,5,77,76],
						[89,5,77,76],
						[171,5,77,76],
						[225,5,77,76],
						[337,5,77,76],
						[420,5,77,76],
						[501,5,77,76],
						[583,5,77,76],

						[14,97,77,76],
						[98,97,77,76],
						[182,97,77,76],

						[278,92,92,81],
						[375,91,78,82],
						[461,90,70,83],
						[536,98,97,75],

						[4,181,81,83],
						[95,182,76,82],
						[187,183,71,81],
					],
					animations: {
						"parado": [8, 10, "parado", 0.3],
						"andar": {
							frames: [10,13,12,11,14,10,15,16,17],
							next: "andar",
							speed: 0.3
						},
						"atirar": {
							frames: [7,6,5,4,2,1,0],
							next: "andar",
							speed: 0.3
						}
					}
				});

				/* Animações das moedas */
				spriteMoeda = new createjs.SpriteSheet({
					framerate: 20,
					images: [loader.getResult("moeda")],
					frames: {width: 44, height: 40},
					animations: {
						"rodando": [0, 8, "rodando", 0.8],
					}
				});

				/* Background do menu */
				bg.graphics.beginBitmapFill(bgImg, "repeat-x").drawRect(0, 0, cwidth, cheight);

				/* Inicia o menu */
				menu.iniciar();
				creditos.iniciar();

			}

			function startGame(){

				/* Remove tudo da canvas */
				palco.removeAllEventListeners();
				palco.removeAllChildren();

				/* Cria o cenário */
				cenarioImg = loader.getResult("cenario");
				cenario = new createjs.Shape();

				/* Matrix 2d */
				matrix = new createjs.Matrix2D();

				/* Cria um container para itens de coordenadas traduzidas */
				traduzidos = new createjs.Container();

				/* Inicia os objetos */
				personagem.iniciar();
				virus.iniciar(5);
				tiros.iniciar();
				municao.iniciar();

				/* Insere na canvas os itens de coordenadas traduzidas */
				palco.addChild(cenario,traduzidos);

				/* Registra os eventos do teclado e mouse */
				document.addEventListener("keydown", keydown);
				document.addEventListener("keyup", keyup);
				palco.addEventListener("stagemousedown", tiros.novo);

				/* Request Animation Frame: loop */
				createjs.Ticker.timingMode = createjs.Ticker.RAF;
				createjs.Ticker.addEventListener("tick", tick);

			}

			function tick(event){

				/* Muda a posição dos itens de coordenadas traduzidas */
   				traduzidos.regX = pos;

   				/* Desenha o cenário e faz o efeito "infinito" */
   				cenario.graphics.clear().beginBitmapFill(cenarioImg, "repeat-x", matrix).drawRect(0, 0, cenarioImg.width, cenarioImg.height);

   				/* Atualiza objetos */
   				tiros.update();
   				virus.update();
   				fogo.update();
   				vida.update();
   				municao.update();
   				moedas.update();
   				score.update();

   				/* Atualiza a canvas */
				palco.update(event);

			}

			function keydown(event){

				switch(event.keyCode){

					case KEYS.LEFT:

						if(KEYS.LEFT in KEYS._keys == false){

							_personagem.gotoAndPlay("andar");
							_personagem.on("animationend",function(){ delete KEYS._keys[KEYS.LEFT]; });

						}

						personagem.andar('left');
						break;

					case KEYS.RIGHT:

						if(KEYS.RIGHT in KEYS._keys == false){

							_personagem.gotoAndPlay("andar");
							_personagem.on("animationend",function(){ delete KEYS._keys[KEYS.RIGHT]; });

						}

						personagem.andar('right');
						break;

					case KEYS.UP:

						if(KEYS.UP in KEYS._keys == false){

							_personagem.gotoAndPlay("pular");
							_personagem.on("animationend",function(){ delete KEYS._keys[KEYS.UP]; });

						}

						personagem.pular();
						break;

					case KEYS.DOWN:

						if(KEYS.DOWN in KEYS._keys == false){

							_personagem.gotoAndPlay("agachar");
							personagem.agachar();

						}

						break;

					case KEYS.SPACE:

						if(KEYS.SPACE in KEYS._keys == false){

							_personagem.gotoAndPlay("saltar");
							_personagem.on("animationend",function(){ delete KEYS._keys[KEYS.SPACE]; });

						}

						personagem.saltar();
						break;

					default:
						return false;

				}

				KEYS._keys[event.keyCode] = true;

			}

			function keyup(event){

				switch(event.keyCode){

					case KEYS.DOWN:

						_personagem.gotoAndPlay("subir");
						personagem.subir();
						break;

					case KEYS.UP:

						break;

					case KEYS.SPACE:

						break;

					default:
						_personagem.gotoAndStop("parado");

				}

				delete KEYS._keys[event.keyCode];

			}

			/* Menu */
			var menu = {

				container: new createjs.Container(),
				startButton: "jogar",
				creditosButton: "creditos",
				title: new createjs.Text(nome, "100px Comic Sans", "#fff"),
				shadow: new createjs.Shadow("red", 8, 8, 15),

				iniciar: function(){

					/* Sombra do texto */
					this.title.shadow = this.shadow;

					/* Definições do texto */
					this.title.x = (cwidth - this.title.getBounds().width) / 2;
					this.title.y = 100;

					/* Imagens do menu */
					this.startButton = new createjs.Bitmap(loader.getResult(this.startButton));
					this.creditosButton = new createjs.Bitmap(loader.getResult(this.creditosButton));

					/* Definições do botão do menu */
					this.startButton.x = ((cwidth - this.startButton.getBounds().width) / 2) - 150;
					this.startButton.y = 400;

					/* Definições do botão de creditos */
					this.creditosButton.x = ((cwidth - this.creditosButton.getBounds().width) / 2) + 150;
					this.creditosButton.y = 400;

					/* Mostra o menu */
					this.show();

				},

				show: function(){

					/* Registra a ação para startGame() */
					this.startButton.addEventListener("click", startGame);

					/* Registra a ação de creditosGame() */
					this.creditosButton.addEventListener("click", function(){ creditos.show(); });

					/* Adiciona as imagens no container menu */
					this.container.addChild(bg, this.startButton, this.creditosButton, this.title);

					/* Registra a ação para startGame() */
					this.startButton.addEventListener("click", startGame);

					/* Remove tudo da canvas */
					palco.removeAllEventListeners();
					palco.removeAllChildren();

					/* Insere o container menu na canvas */
					palco.addChild(this.container);

					/* Atualizaa tela */
					palco.update();

				}

			},

			creditos = {

				container: new createjs.Container(),
				backButton: "back",
				title: new createjs.Text("Créditos", "100px Comic Sans", "#fff"),
				shadow: menu.shadow.clone(),

				iniciar: function(){

					/* Sombra do texto */
					this.title.shadow = this.shadow;

					/* Definições do texto */
					this.title.x = (cwidth - this.title.getBounds().width) / 2;
					this.title.y = 100;

					/* Imagens dos creditos */
					this.backButton = new createjs.Bitmap(loader.getResult(this.backButton));

					/* Definições do botão de voltar */
					this.backButton.x = (cwidth - this.backButton.getBounds().width) / 2;
					this.backButton.y = 400;

				},

				show: function(){

					/* Registra a ação para voltar() */
					this.backButton.addEventListener("click", function(){ menu.show(); });

					/* Adiciona as imagens no container creditos */
					this.container.addChild(bg, this.backButton, this.title);

					/* Remove tudo da canvas */
					palco.removeAllEventListeners();
					palco.removeAllChildren();

					/* Insere o container menu na canvas */
					palco.addChild(this.container);

					/* Atualizaa tela */
					palco.update();

				}

			},

			/* Personagem */
			personagem = {

				speed: 10,
				life: 100,
				saltoX: 350,
				saltoY: 250,
				puloY: 250,
				saltoSpeed:250,
				puloSpeed:350,

				iniciar: function(){

					_personagem = new createjs.Sprite(spritePersonagem, "parado");
					_personagem.x = marginX;
					_personagem.y = cheight - chao - personagem.height();

					traduzidos.addChild(_personagem);

				},

				width: function(){

					return spritePersonagem.getFrameBounds(_personagem.currentFrame).width;

				},

				height: function(){

					return spritePersonagem.getFrameBounds(_personagem.currentFrame).height;

				},

				andar: function(dir){

					if(dir == 'left'){

						_personagem.scaleX = -1;

						if(_personagem.x - this.speed >= canvasInicio + marginX){

							_personagem.x -= this.speed;

						}

					}else if(dir == 'right'){

						_personagem.scaleX = 1;

						if(_personagem.x + personagem.width() > (cwidth/2) + pos && pos < (cenarioImg.width*2)){

							pos += this.speed;

							canvasInicio = pos;
							canvasFim = cwidth + pos;

							matrix.translate(-this.speed,0);

							_personagem.x += this.speed;

						}else if(_personagem.x + personagem.width() + this.speed <= canvasFim - marginX){

							_personagem.x += this.speed;

						}

					}

				},

				agachar: function(){

					createjs.Tween.get(_personagem).to({y: 460}, 130);

				},

				subir: function(){

					createjs.Tween.get(_personagem).to({

						y: cheight - chao - personagem.height()

					},130);

				},

				pular: function(){

					createjs.Tween.get(_personagem).to({

						y: cheight - chao - personagem.puloY

					}, personagem.puloSpeed)

					.call(function(){

						createjs.Tween.get(_personagem).to({

							y: cheight - chao - personagem.height()

						}, personagem.puloSpeed)

						.call(function(){

							_personagem.gotoAndStop("parado");

						});

					});

				},

				saltar: function(){

					if((_personagem.x + personagem.width() + personagem.saltoX <= canvasFim - marginX) && (_personagem.scaleX == 1) || (_personagem.x - personagem.saltoX >= canvasInicio + marginX) && (_personagem.scaleX == -1)){

						var _x = _personagem.x - (personagem.saltoX / 2);

						if(_personagem.scaleX == 1)
							_x = _personagem.x + (personagem.saltoX / 2);

						createjs.Tween.get(_personagem).to({

							x: _x,
							y: cheight - chao - personagem.saltoY

						}, personagem.saltoSpeed)

						.call(function(){

							_x = _personagem.x - (personagem.saltoX / 2);

							if(_personagem.scaleX == 1)
								_x = _personagem.x + (personagem.saltoX / 2);

							createjs.Tween.get(_personagem).to({

								x: _x,
								y: cheight - chao - personagem.height()

							}, personagem.saltoSpeed)

							.call(function(){

								_personagem.gotoAndStop("parado");

							});

						});

					}else{

						_personagem.gotoAndStop("parado");

					}

				}

			},

			/* Tiros */
			tiros = {

				_tiros: [],
				qtd: 40,
				speed: 15,
				damage: 1,
				img: "tiro",

				iniciar: function(){

					this.img = loader.getResult(this.img);

				},

				novo: function(){

					if(tiros.qtd > 0){

						var tiro = new createjs.Bitmap(tiros.img);
						tiro.x = _personagem.x;
						tiro.y = _personagem.y + 25;
						tiro.scaleX = _personagem.scaleX;

						if(tiro.scaleX == 1)
							tiro.x = _personagem.x + personagem.width();

						tiros._tiros.push(tiro);

						traduzidos.addChild(tiro);

						_personagem.gotoAndPlay("atirar");

						tiros.qtd--;

					}

				},

				alvo: function(tiro){

					var ret = false;

					for(var i = 0; i < virus._virus.length; i++){

						var bounds = spriteVirus.getFrameBounds(virus._virus[i].currentFrame);

						if(colidir(this._tiros[tiro], virus._virus[i], this.img, bounds)){

							virus._virus[i].life -= this.damage;

							if(virus._virus[i].life <= 0){

								traduzidos.removeChild(virus._virus[i]);

								moedas.novo(virus._virus[i].x, virus._virus[i].y, virus._virus[i].coins);

								virus._virus.splice(i,1);

							}

							ret = true;
							break;

						}

					}

					return ret;

				},

				update: function(){

					for(var i = 0; i < this._tiros.length; i++){

						if(this._tiros[i].x < canvasInicio || this._tiros[i].x > canvasFim || this.alvo(i)){

							traduzidos.removeChild(this._tiros[i]);
							this._tiros.splice(i,1);

						}else{

							this._tiros[i].x += this.speed * this._tiros[i].scaleX;

						}

					}

				}

			},

			/* Vírus */
			virus = {

				_virus: [],
				speed: 0.5,
				life: 10,

				iniciar: function(qtd){

					this.novo(qtd);

				},

				novo: function(qtd){

					for(var i = 0; i < qtd; i++){

						var vr = new createjs.Sprite(spriteVirus, "andar");
						vr.x = canvasFim + (i * 200);
						vr.y = cheight - chao - 76;
						vr.dir = -1;
						vr.life = this.life;
						vr.coins = 100;

						vr.width = function(){ return spriteVirus.getFrameBounds(this.currentFrame).width; };
						vr.height = function(){ return spriteVirus.getFrameBounds(this.currentFrame).height; };

						this._virus.push(vr);

						traduzidos.addChild(vr);

					}

				},

				alvo: function(){},

				update: function(){

					for(var i = 0; i < this._virus.length; i++){

						if(this._virus[i].x <= canvasInicio + marginX && this._virus[i].dir !== 1){

							this._virus[i].dir = 1;
							this._virus[i].scaleX = -1;

						}else if(this._virus[i].x >= canvasFim - marginX && this._virus[i].dir !== -1){

							this._virus[i].dir = -1;
							this._virus[i].scaleX = 1;

						}else{

							this._virus[i].x += this.speed * this._virus[i].dir;

						}

					}

				}

			},

			fogo = {

				_fogos: [],
				damage: 1,
				speed: 15,

				novo:function(){},

				alvo: function(){},

				update: function(){}

			},

			vida = {

				_vidas: [],
				value: 1,
				time: 40,

				novo: function(){},

				pegou: function(){},

				update: function(){}

			},

			municao = {

				_cx: [],
				value: 10,
				time: 40,
				img: "municao",

				iniciar: function(){

					this.img = loader.getResult(this.img);

				},

				novo: function(){

					var m = new createjs.Bitmap(municao.img);
					m.x = getRandom((canvasInicio + marginX),(canvasFim - marginX - this.img.width));
					m.y = cheight - chao - this.img.height;

					var i = this._cx.push(m);

					setTimeout(function(){

						traduzidos.removeChild(m);
						municao._cx.splice(i - 1, 1);

					 }, this.time * 1000);

					traduzidos.addChild(m);

				},

				pegou: function(c){

					var bounds = spritePersonagem.getFrameBounds(_personagem.currentFrame);

					if(colidir(this._cx[c], _personagem, this.img, bounds)){

						tiros.qtd += this.value;

						return true;

					}else{

						return false;

					}

				},

				update: function(){

					if(this._cx.length == 0 && tiros.qtd == 0){

						this.novo();

					}else{

						for(var i = 0; i < this._cx.length; i++){

							if(this._cx[i].x + this.img.width < canvasInicio || this._cx[i].x > canvasFim || this.pegou(i)){

								traduzidos.removeChild(this._cx[i]);
								this._cx.splice(i,1);

							}

						}

					}

				}

			},

			moedas = {

				_moedas: [],
				time: 40,

				novo: function(x, y, coins){

					var m = new createjs.Sprite(spriteMoeda, "rodando");;
					m.x = x;
					m.y = y;
					m.value = coins;

					m.width = function(){ return spriteMoeda.getFrameBounds(this.currentFrame).width; };
					m.height = function(){ return spriteMoeda.getFrameBounds(this.currentFrame).height; };

					var i = this._moedas.push(m);

					setTimeout(function(){

						traduzidos.removeChild(m);
						moedas._moedas.splice(i - 1, 1);

					 }, this.time * 1000);

					traduzidos.addChild(m);

				},

				pegou: function(m){

					var bounds = spriteMoeda.getFrameBounds(this._moedas[m].currentFrame);
					var bounds2 = spritePersonagem.getFrameBounds(_personagem.currentFrame);

					if(colidir(this._moedas[m], _personagem, bounds, bounds2)){

						score.value += this._moedas[m].value;

						return true;

					}else{

						return false;

					}

				},

				update: function(){

					for(var i = 0; i < this._moedas.length; i++){

						if(this._moedas[i].x + this._moedas[i].width() < canvasInicio || this._moedas[i].x > canvasFim || this.pegou(i)){

							traduzidos.removeChild(this._moedas[i]);
							this._moedas.splice(i,1);

						}

					}

				}

			},

			score = {

				value: 0,

				update: function(){}

			};

		</script>

	</body>

</html>